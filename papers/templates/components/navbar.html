<nav class="bg-white p-4 shadow flex items-center dark:bg-zinc-900">
  <div class="container mx-auto flex items-center justify-between">

    <!-- Logo -->
    <a href="/" class="font-bold text-xl dark:text-gray-200">Academic Repo</a>

    <!-- Dark mode toggle -->
    <button id="theme-toggle"
      class="ml-6 p-2 rounded-md border border-gray-300 text-gray-700 dark:text-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">
      ðŸŒ™
    </button>

    <!-- Search with icon -->
    <form action="{% url 'paper_list' %}" 
          method="get" 
          autocomplete="off" 
          role="search" 
          class="flex-1 relative mx-4 flex"
          id="search-form">
      <!-- Search Icon -->
      <svg class="absolute left-7 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400 dark:text-gray-200 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <circle cx="11" cy="11" r="8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></line>
      </svg>

      <!-- Input + Clear Button -->
      <div x-data="{ open:false, query:'{{ request.GET.q|default:'' }}' }" class="flex-1 relative mx-4">
        <input
          type="search"
          name="q"
          id="global-search"
          x-model="query"
          placeholder="Search papers, authors, or topics..."
          value="{{ request.GET.q }}"
          class="w-full pl-10 pr-10 py-2 rounded-md border border-gray-300 dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
          role="combobox"
          aria-autocomplete="list"
          :aria-expanded="open"
          aria-controls="autocomplete-results"
          hx-get="{% url 'autocomplete' %}"
          hx-trigger="keyup changed delay:250ms"
          hx-target="#autocomplete-results"
          hx-swap="innerHTML"
          @autocomplete-select.window="(e) => {
            if(e.detail.type === 'paper' && e.detail.paper_id){
              window.location.href = '/papers/papers/' + e.detail.paper_id + '/';
            } else if(e.detail.type === 'author'){
              document.getElementById('global-search').value = e.detail.value;
              var authorInput = document.getElementById('search-author');
              if(!authorInput){
                authorInput = document.createElement('input');
                authorInput.type = 'hidden';
                authorInput.name = 'author';
                authorInput.id = 'search-author';
                document.getElementById('search-form').appendChild(authorInput);
              }
              authorInput.value = e.detail.value;
              document.getElementById('search-form').submit();
            } else {
              document.getElementById('global-search').value = e.detail.value;
            }
          }"
          @focus="open = true"
          @blur="setTimeout(()=> open=false,150)"
          @keydown.escape="open=false"
        >

        <!-- Clear (X) button -->
        <button
          type="button"
          x-show="query"
          @click="query=''; open=false"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:text-zinc-500 dark:hover:text-zinc-200 transition"
        >
          âœ•
        </button>

        <!-- Results dropdown -->
        <div id="autocomplete-results" x-show="open" class="absolute left-0 right-0 z-50 mt-1"></div>
      </div>
    </form>

    <!-- Mobile Menu / Login -->
    {% if user.is_authenticated %}
      <!-- Logged in: Hamburger menu -->
      <div x-data="{ open: false }" class="relative sm:hidden">
        <button @click="open = !open" class="btn btn-square btn-ghost">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <div x-show="open" x-transition class="absolute right-0 mt-2 w-48 bg-white border rounded shadow-lg z-50 flex flex-col">
          <a href="{% url 'saved_papers' %}" class="px-4 py-2 hover:bg-gray-100">Library</a>
          <a href="{% url 'home' %}" class="px-4 py-2 hover:bg-gray-100">Home</a>
          <a href="{% url 'paper_list' %}" class="px-4 py-2 hover:bg-gray-100">Papers</a>
          <a href="{% url 'paper_upload' %}" class="px-4 py-2 hover:bg-gray-100">Upload</a>
          <a href="{% url 'profile_page' %}" class="px-4 py-2 hover:bg-gray-100">Hi, {{ user.username }}</a>
          <a href="{% url 'account_logout' %}" class="px-4 py-2 hover:bg-gray-100">Logout</a>
        </div>
      </div>

      <!-- Desktop Links -->
      <ul class="hidden sm:flex gap-4 text-sm">
        <li><a href="{% url 'saved_papers' %}" class="hover:underline">Library</a></li>
        <li><a href="{% url 'paper_insights' %}" class="hover:underline">Overview</a></li>
        <li><a href="{% url 'home' %}" class="hover:underline">Home</a></li>
        <li><a href="{% url 'paper_list' %}" class="hover:underline">Papers</a></li>
        <li><a href="{% url 'paper_upload' %}" class="hover:underline">Upload</a></li>
        <li><a href="{% url 'profile_page' %}" class="hover:underline">Hi, {{ user.username }}</a></li>
        <li><a href="{% url 'account_logout' %}" class="hover:underline">Logout</a></li>
      </ul>
    {% else %}
      <!-- Not logged in: show login button only on mobile -->
      <a href="{% url 'account_login' %}" class="btn btn-sm btn-primary sm:hidden">Login</a>
      <ul class="hidden sm:flex gap-4 text-sm">
        <li><a href="{% url 'saved_papers' %}" class="hover:underline">Library</a></li>
        <li><a href="{% url 'home' %}" class="hover:underline">Home</a></li>
        <li><a href="{% url 'paper_list' %}" class="hover:underline">Papers</a></li>
        <li><a href="{% url 'paper_upload' %}" class="hover:underline">Upload</a></li>
        <li><a href="{% url 'account_login' %}" class="hover:underline">Login</a></li>
        <li><a href="{% url 'account_signup' %}" class="hover:underline">Register</a></li>
      </ul>
    {% endif %}

  </div>
</nav>

<script>
  const html = document.documentElement;
  const btn = document.getElementById('theme-toggle');

  // Load saved preference
  if (localStorage.theme === 'dark') html.classList.add('dark');

  btn.addEventListener('click', () => {
    html.classList.toggle('dark');
    localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
  });

  // Handle search form submission
  document.getElementById('search-form').addEventListener('submit', function(e) {
    const contentTarget = document.getElementById('paper-list-content');
    
    // If we're on a page with the paper-list-content div, use HTMX
    if (contentTarget) {
      e.preventDefault();
      const formData = new FormData(this);
      const params = new URLSearchParams(formData).toString();
      
      htmx.ajax('GET', '{% url "paper_list_partial" %}?' + params, {
        target: '#paper-list-content',
        swap: 'innerHTML',
        pushUrl: true
      });
    }
    // Otherwise, let it submit normally (will navigate to paper_list page)
  });
</script>