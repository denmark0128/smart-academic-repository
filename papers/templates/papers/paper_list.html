{% extends 'layouts/base.html' %}

{% block title %}Paper List{% endblock %}

{% block content %}
<div class="flex flex-col items-start min-h-[60vh]" x-data="{ view: localStorage.getItem('paperView') || 'card' }" x-init="$watch('view', v => localStorage.setItem('paperView', v))">

  <div class="flex flex-col md:flex-row items-start min-h-[60vh]" x-data="{ view: localStorage.getItem('paperView') || 'card', filterOpen: JSON.parse(localStorage.getItem('filterOpen') ?? 'false') }" x-init="$watch('view', v => localStorage.setItem('paperView', v)); $watch('filterOpen', value => localStorage.setItem('filterOpen', JSON.stringify(value)))">

    <!-- Main Paper List and Controls -->
    <div class="flex-1 w-full">
      <!-- View Toggle & Filters Button Row -->
      <div class="w-full max-w-5xl px-4 mt-2 mb-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div class="inline-flex rounded-md shadow-sm bg-gray-100 dark:bg-zinc-800 dark:text-zinc-300 dark:border-zinc-700">
          <button type="button"
            :class="view === 'card' ? 'bg-white text-blue-600 font-semibold border border-blue-500 dark:bg-zinc-600 dark:text-zinc-300 dark:border-zinc-700' : 'text-gray-500 border border-transparent'"
            class="px-3 py-1 rounded-l-md focus:outline-none transition"
            @click="view = 'card'">
            <svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="3" y="4" width="7" height="7" class="fill-current"/><rect x="14" y="4" width="7" height="7" class="fill-current"/><rect x="14" y="13" width="7" height="7" class="fill-current"/><rect x="3" y="13" width="7" height="7" class="fill-current"/></svg> Card
          </button>
          <button type="button"
            :class="view === 'compact' ? 'bg-white text-blue-600 font-semibold border border-blue-500 dark:bg-zinc-600 dark:text-zinc-300 dark:border-zinc-700' : 'text-gray-500 border border-transparent'"
            class="px-3 py-1 rounded-r-md focus:outline-none transition"
            @click="view = 'compact'">
            <svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="3" y="6" width="18" height="4" class="fill-current"/><rect x="3" y="14" width="18" height="4" class="fill-current"/></svg> Compact
          </button>
        </div>
        <button @click="filterOpen = !filterOpen"
                class="btn btn-outline btn-primary flex items-center gap-2 px-4 py-2 font-semibold shadow-sm border border-blue-500 hover:bg-blue-50 transition dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300"
                type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-6.414 6.414A1 1 0 0013 13.414V19a1 1 0 01-1.447.894l-2-1A1 1 0 019 18v-4.586a1 1 0 00-.293-.707L2.293 6.707A1 1 0 012 6V4z" /></svg>
          <span>Filters</span>
        </button>
      </div>

      <!-- Filter Section (always below the buttons) -->
      <div class="w-full max-w-5xl px-4">
        <div x-show="filterOpen" x-cloak
             x-transition 
             class="mt-2 p-6 shadow bg-white rounded-2xl border border-blue-200 w-full dark:bg-zinc-900 dark:border-zinc-700">
          <form id="filters" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}

            <input type="hidden" name="view_mode" x-model="view">
            <!-- College -->
            <div>
              <label class="block mb-1 text-sm font-semibold text-blue-700 dark:text-zinc-300">College</label>
              <select name="college" class="p-3 select select-bordered w-full dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300"
                      hx-get="{% url 'paper_list' %}" 
                      hx-target="#papers-content"
                      hx-push-url="true"
                      hx-include="#filters [name]"
                      hx-trigger="change">
                <option value="">All Colleges</option>
                {% for college in colleges %}
                  <option value="{{ college }}" {% if selected_college == college %}selected{% endif %}>
                    {{ college }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Program -->
            <div>
              <label class="block mb-1 text-sm font-semibold text-blue-700 dark:text-zinc-300">Program</label>
              <select name="program" class="p-3 select select-bordered w-full dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300"
                      hx-get="{% url 'paper_list' %}" 
                      hx-target="#papers-content"
                      hx-push-url="true"
                      hx-include="#filters [name]"
                      hx-trigger="change">
                <option value="">All Programs</option>
                {% for program in programs %}
                  <option value="{{ program }}" {% if selected_program == program %}selected{% endif %}>
                    {{ program }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Year -->
            <div>
              <label class="block mb-1 text-sm font-semibold text-blue-700 dark:text-zinc-300">Year</label>
              <select name="year" class="p-3 select select-bordered w-full dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300"
                      hx-get="{% url 'paper_list' %}" 
                      hx-target="#papers-content"
                      hx-push-url="true"
                      hx-include="#filters [name]"
                      hx-trigger="change">
                <option value="">All Years</option>
                {% for year in years %}
                  <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>
                    {{ year }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </form>

          {% if active_filters %}
            <div class="mt-6 flex flex-wrap gap-2">
              {% for filter in active_filters %}
                <div class="badge badge-outline gap-2">
                  {{ filter.label }}: {{ filter.value }}
                  <a href="?{% if query %}q={{ query }}&{% endif %}{{ filter.remove_url }}" 
                     class="text-xs hover:text-error">âœ•</a>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="mt-4" id="active-filters">
        {% include "papers/partials/paper_list/_active_filters.html" %}
      </div>
      <!-- Content Section -->
      <div id="papers-content" class="w-full max-w-5xl px-4">
        <div x-show="view === 'card'" x-transition>
          {% include "papers/partials/paper_list/_paper_list_content.html" with view_mode='card' %}
        </div>
        <div x-show="view === 'compact'" x-transition>
          {% include "papers/partials/paper_list/_paper_list_content.html" with view_mode='compact' %}
        </div>
      </div>
    </div>


    <!-- Hidden form for HTMX include -->
<form id="filters" class="hidden">
  {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}
  {% if selected_college %}<input type="hidden" name="college" value="{{ selected_college }}">{% endif %}
  {% if selected_program %}<input type="hidden" name="program" value="{{ selected_program }}">{% endif %}
  {% if selected_year %}<input type="hidden" name="year" value="{{ selected_year }}">{% endif %}
  {% for t in tags %}
    <input type="hidden" name="tag" value="{{ t }}">
  {% endfor %}
</form>

<!-- Browse Tags Sidebar -->
<aside class="w-full md:w-64 md:ml-6 mt-8 md:mt-2 ">
  <div class="bg-white rounded-2xl shadow border border-blue-100 p-4 sticky top-4 dark:bg-zinc-900 dark:border-zinc-700">
    <h3 class="text-base font-bold text-blue-700 mb-3 dark:text-zinc-300">Browse Tags</h3>
    <div class="flex flex-wrap gap-3">
      {% for tag, count in tag_counts.items %}
        {% cycle 'blue' 'purple' 'green' 'yellow' 'orange' 'red' 'cyan' as color silent %}
        <a href="#"
           hx-get="{% url 'paper_list' %}"
           hx-target="#papers-content"
           hx-push-url="true"
           hx-include="#filters"
           hx-vals='{"tag": ["{{ tag }}"]}'>
          <span class="flex items-center gap-2 rounded-full font-semibold border transition duration-200
                       {% if count > 6 %}text-lg px-5 py-2{% elif count > 3 %}text-base px-4 py-1.5{% else %}text-sm px-3 py-1{% endif %}
                       {% if color == 'blue' %}bg-blue-50 text-blue-800 border-blue-300 hover:bg-blue-100 dark:bg-blue-900 dark:border-blue-700 dark:text-blue-500{% endif %}
                       {% if color == 'purple' %}bg-purple-50 text-purple-800 border-purple-300 hover:bg-purple-100 dark:bg-purple-900 dark:border-purple-700 dark:text-purple-500{% endif %}
                       {% if color == 'green' %}bg-green-50 text-green-800 border-green-300 hover:bg-green-100 dark:bg-green-900 dark:border-green-700 dark:text-green-500{% endif %}
                       {% if color == 'yellow' %}bg-yellow-50 text-yellow-800 border-yellow-300 hover:bg-yellow-100 dark:bg-yellow-900 dark:border-yellow-700 dark:text-yellow-500{% endif %}
                       {% if color == 'orange' %}bg-orange-50 text-orange-800 border-orange-300 hover:bg-orange-100 dark:bg-orange-900 dark:border-orange-700 dark:text-orange-500{% endif %}
                       {% if color == 'red' %}bg-red-50 text-red-800 border-red-300 hover:bg-red-100 dark:bg-red-900 dark:border-red-700 dark:text-red-500{% endif %}
                       {% if color == 'cyan' %}bg-cyan-50 text-cyan-800 border-cyan-300 hover:bg-cyan-100 dark:bg-cyan-900 dark:border-cyan-700 dark:text-cyan-500{% endif %}">
            {{ tag }}
            <span class="opacity-70 text-xs font-bold">({{ count }})</span>
          </span>
        </a>
      {% empty %}
        <div class="flex flex-col items-center justify-center py-8">
          <svg class="w-10 h-10 text-blue-100 mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M8 12h8M12 8v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <span class="text-gray-400 text-sm font-semibold">No tags found</span>
          <span class="text-gray-300 text-xs">Tags will appear here when available.</span>
        </div>
      {% endfor %}
    </div>
  </div>
</aside>



  </div>
  {% endblock %}
