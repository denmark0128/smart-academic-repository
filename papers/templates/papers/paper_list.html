{% extends 'layouts/base.html' %}

{% block title %}Paper List{% endblock %}

{% block content %}
<div class="flex flex-col items-start min-h-[60vh]">

  <!-- Filter Section -->
  <div class="w-full max-w-5xl px-4 mb-4"
       x-data="{ filterOpen: JSON.parse(localStorage.getItem('filterOpen') ?? 'false') }"
       x-init="$watch('filterOpen', value => localStorage.setItem('filterOpen', JSON.stringify(value)))">

    <button @click="filterOpen = !filterOpen" 
            class="btn btn-ghost w-full flex justify-start gap-2">
      <!-- icon -->
      Filters
    </button>

    <div x-show="filterOpen" x-cloak
         x-transition 
         class="mt-2 p-4 shadow bg-base-100 rounded-box border">
      <form id="filters" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}

        <!-- College -->
        <div>
          <label class="label"><span class="label-text">College</span></label>
          <select name="college" class="select select-bordered w-full"
                  hx-get="{% url 'paper_list' %}" 
                  hx-target="#papers-content"
                  hx-push-url="true"
                  hx-include="#filters [name]"
                  hx-trigger="change">
            <option value="">All Colleges</option>
            {% for college in colleges %}
              <option value="{{ college }}" {% if selected_college == college %}selected{% endif %}>
                {{ college }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Program -->
        <div>
          <label class="label"><span class="label-text">Program</span></label>
          <select name="program" class="select select-bordered w-full"
                  hx-get="{% url 'paper_list' %}" 
                  hx-target="#papers-content"
                  hx-push-url="true"
                  hx-include="#filters [name]"
                  hx-trigger="change">
            <option value="">All Programs</option>
            {% for program in programs %}
              <option value="{{ program }}" {% if selected_program == program %}selected{% endif %}>
                {{ program }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Year -->
        <div>
          <label class="label"><span class="label-text">Year</span></label>
          <select name="year" class="select select-bordered w-full"
                  hx-get="{% url 'paper_list' %}" 
                  hx-target="#papers-content"
                  hx-push-url="true"
                  hx-include="#filters [name]"
                  hx-trigger="change">
            <option value="">All Years</option>
            {% for year in years %}
              <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>
                {{ year }}
              </option>
            {% endfor %}
          </select>
        </div>
      </form>

      {% if active_filters %}
        <div class="mt-4 flex flex-wrap gap-2">
          {% for filter in active_filters %}
            <div class="badge badge-outline gap-2">
              {{ filter.label }}: {{ filter.value }}
              <a href="?{% if query %}q={{ query }}&{% endif %}{{ filter.remove_url }}" 
                 class="text-xs hover:text-error">âœ•</a>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      
    </div>
  </div>
<div class="mt-4" id="active-filters">
      {% include "papers/partials/paper_list/_active_filters.html" %}
    </div>
  <!-- Content Section -->
  <div id="papers-content" class="w-full max-w-5xl px-4">
    {% include "papers/partials/paper_list/_paper_list_content.html" %}
  </div>
</div>
{% endblock %}
