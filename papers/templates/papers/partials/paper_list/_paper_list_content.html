{% load static %}

<!-- Paper List Container - This is what gets swapped -->
<div id="paper-list-container">
  <div id="list-content">
    <!-- OOB swap for Active Filters -->
    <div id="active-filters" hx-swap-oob="true">
      {% include "papers/partials/paper_list/_active_filters.html" %}
    </div>

    <!-- Show heading for query -->
    {% if query %}
    <h2 class="text-lg font-semibold mb-2 dark:text-gray-300">
      {{ page_obj.paginator.count }} result{{ page_obj.paginator.count|pluralize }} for "<span class="text-black dark:text-gray-300">{{ query }}</span>"
    </h2>
    {% endif %}

    {% if active_filters %}
      <div class="mb-4">
        <p class="text-sm text-gray-600 mb-2">
          {{ page_obj.paginator.count }} paper{{ page_obj.paginator.count|pluralize }} found 
        </p>

        <!-- Removable tags (including main filter) -->
        <div class="flex flex-wrap gap-2">
          {% for filter in active_filters %}
            <div class="flex items-center gap-1 px-3 py-1 rounded-full {% if forloop.first %}bg-blue-100 text-blue-800 font-semibold{% else %}bg-gray-100 text-gray-800{% endif %} text-sm">
              <span>{{ filter.label }}: {{ filter.value }}</span>
              <a href="?{% if query %}q={{ query }}&{% endif %}{{ filter.remove_url }}"
                 hx-get="?{% if query %}q={{ query }}&{% endif %}{{ filter.remove_url }}"
                 hx-target="#paper-list-container"
                 hx-select="#paper-list-container"
                 class="ml-1 text-xs hover:text-red-600 font-bold">
                ×
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Search Results -->
  <div x-show="view === 'compact'" class="grid grid-cols-1 md:grid-cols-2 gap-2">
    {% for item in page_obj %}
      <div class="border rounded-lg bg-white p-4 border-gray-200 hover:shadow transition flex flex-col h-full dark:bg-gray-700/30 dark:border-gray-800 dark:text-gray-300
      {% if item.paper.college == 'ccs' %}border-l-4 border-l-slate-800 dark:border-l-gray-400{% elif item.paper.college == 'cba' %}border-l-4  border-l-yellow-400{% endif %}">

        {% if item.paper %}
          <a href="{% url 'paper_detail' item.paper.pk %}" class="font-semibold text-base text-gray-950 tracking-tight hover:underline mb-1 dark:text-gray-300">{{ item.paper.title }}</a>
          {% if item.score and item.score != '-' %}
            <div class="text-xs text-gray-500 mb-1 dark:text-gray-400">
              Similarity: {{ item.score }}
            </div>
          {% endif %}
        {% else %}
          <span class="text-base text-gray-400 font-semibold dark:text-gray-300">[Paper not found]</span>
        {% endif %}

        
        <div class="text-xs text-gray-800 mb-1 dark:text-gray-400">
          {% if item.paper and item.paper.authors %}
            {{ item.paper.authors|join:', ' }}
          {% endif %}
        </div>

        
        <div class="text-xs text-gray-500 mb-1 dark:text-gray-300">
          {% if item.paper %}{{ item.paper.college }}{% endif %} {% if item.paper %}{{ item.paper.program }}{% endif %} {% if item.paper %}- {{ item.paper.year }}{% endif %}
        </div>
        <div class="text-xs mb-1 ">
          {% if item.snippet %}{{ item.snippet|truncatechars_html:100|safe }}{% endif %}
        </div>
        <div class="flex flex-wrap gap-1 mb-2">
          {% if item.tags %}
            {% for tag in item.tags %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 dark:bg-blue-950/30 text-blue-800 dark:text-blue-300 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-950/50 transition-colors">
            {{ tag }}
          </span>
            {% endfor %}
          {% endif %}
        </div>
        <div class="mt-auto flex gap-2">
          {% if item.paper %}
          {% if request.user.is_staff or request.user.is_superuser or request.user.email|slice:"-14:" == "plpasig.edu.ph" %}
            <a href="{{ item.paper.file.url }}" download class="btn btn-xs btn-outline text-red-600">PDF</a>
            
            {% endif %}
            <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" target="_blank" class="btn btn-xs btn-outline dark:text-gray-300 dark:hover:gray-200">View</a>
            {% if item.paper.merged_html %}
              <a href="{{ item.paper.merged_html.url }}" target="_blank" class="btn btn-xs btn-outline dark:text-gray-300 dark:hover:gray-200">HTML</a>
            
            {% endif %} 
          {% endif %}
        </div>
      </div>
    {% empty %}
      <div class="col-span-2 text-center text-gray-500 py-8">No results found.</div>
    {% endfor %}

    
  </div>

  <!-- Card View -->
  {% for item in page_obj %}
    <div x-show="view === 'card'"
     class="mb-2 border rounded-lg bg-white p-4 border-gray-200 border-l-4 shadow-sm hover:shadow-xl transition dark:bg-gray-700/30 dark:border-gray-700
     {% if item.paper.college == 'ccs' %}border-l-slate-800 dark:border-l-gray-400{% elif item.paper.college == 'cba' %}border-l-yellow-400{% endif %}">

      <!-- Title -->
      {% if item.paper %}
        <a href="{% url 'paper_detail' item.paper.pk %}" class="text-xl mb-2 text-black font-semibold hover:underline dark:text-gray-300">
          {{ item.paper.title }}
        </a>
      {% else %}
        <span class="text-xl text-gray-400 font-semibold">[Paper not found]</span>
      {% endif %}

      {% if item.score and item.score != '-' %}
  <div class="text-xs text-gray-500 mb-1 dark:text-gray-400">
    Similarity: {{ item.score }}
  </div>
{% endif %}

      <!-- Author -->
      {% with paper=item.paper %}
        {% if paper.authors %}
          <div class="mt-3 text-sm text-gray-800 dark:text-gray-400">
  {% for author in paper.authors %}
    <span class="font-medium">{{ author }}</span>{% if not forloop.last %}, {% endif %}
  {% endfor %}
  <span class="text-gray-500 uppercase dark:text-gray-400">
    — {{ paper.college }}, {{ paper.program }} {{ paper.year }}
  </span>
</div>
        {% endif %}
      {% endwith %}
        
      <!-- Snippet -->
      <div x-data="{ expanded: false }" x-cloak class="mt-2 text-gray-600  text-sm leading-relaxed dark:text-gray-300 ">
        {% if item.snippet|length > 180 %}
          <!-- Collapsed view -->
          <span x-show="!expanded">
            {{ item.snippet|truncatechars_html:180|safe }} 
            <button @click="expanded = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
          </span>

          <!-- Expanded view -->
          <span x-show="expanded" class="dark:text-gray-300">
            {{ item.snippet|safe }} 
            <button @click="expanded = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
          </span>
        {% else %}
          {{ item.snippet|safe }} 
        {% endif %}
      </div>

      {% if item.paper and item.paper.abstract %}
        <div x-data="{ expandedAbs: false }" x-cloak class="mt-4 text-gray-800 text-xs leading-relaxed">
          <span class="font-semibold text-gray-500">Abstract:</span>
          {% if item.paper.abstract|length > 400 %}
            <span x-show="!expandedAbs" class="dark:text-gray-300">
              {{ item.paper.abstract|truncatechars_html:400|safe }}
              <button @click="expandedAbs = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
            </span>
            <span x-show="expandedAbs " class="dark:text-gray-300">
              {{ item.paper.abstract|safe }}
              <button @click="expandedAbs = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
            </span>
          {% else %}
            {{ item.paper.abstract|safe }}
          {% endif %}
        </div>
      {% endif %}

      {% if item.paper.summary %}
        <div x-data="{ open: false }" x-cloak class="mt-2">
          <button
            @click="open = !open"
            class="text-yellow-800 font-semibold hover:underline focus:outline-none"
          >
            <span x-text="open ? 'Hide Summary' : 'Show Summary'"></span>
          </button>

          <div
            x-show="open"
            x-transition
            class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded text-gray-800 dark:bg-yellow-950 dark:border-yellow-600 dark:text-yellow-200"
          >
            <span class="font-semibold text-yellow-800 dark:text-yellow-600">Summary:</span>
            <span>{{ item.paper.summary }}</span>
          </div>
        </div>
      {% endif %}

      <!-- Tags (Alpine mapping) -->
      {% if item.tags %}
        <div 
  x-data="{
    dark: window.matchMedia('(prefers-color-scheme: dark)').matches,
    topics: {
    },
    findTopic(tag){
      const t = tag.toLowerCase();
      for(const k in this.topics){
        if(t.includes(k)) return this.topics[k];
      }
      return null;
    }
  }"
  x-init="window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => dark = e.matches)"
  class="mt-3 flex flex-wrap gap-2 text-xs mt-6"
> 
  {% for tag in item.tags %}
    <a href="#"
       hx-get="{% url 'paper_list_partial' %}"
       hx-target="#paper-list-container"
       hx-select="#paper-list-container"
       hx-push-url="true"
       hx-include="[name='college'],[name='program'],[name='year']"
       hx-vals='{"tag": "{{ tag }}"}'>
      <span
        x-text="'{{ tag }}'"
        x-bind:class="(() => {
          const t = findTopic('{{ tag }}');
          if (!t) return ' items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 dark:bg-blue-950/30 text-blue-800 dark:text-blue-300 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-950/50 transition-colors';
          return (dark ? t.dark.bg + ' ' + t.dark.text : t.bg + ' ' + t.text) + ' font-semibold px-2 py-1 rounded-full hover:opacity-90';
        })()"
        x-bind:title="findTopic('{{ tag }}')?.title || 'Other'"
      ></span>
      
    </a>
  {% endfor %}
</div>

      {% endif %}
      <!-- Actions -->
  {% if item.paper %}
    <!-- Buttons -->
        <div class="flex flex-row justify-end mt-4 gap-2 w-full items-center">
          {% if ".pdf" in item.paper.file.name %}
            {% if request.user.is_staff or request.user.is_superuser or request.user.email|slice:"-14:" == "plpasig.edu.ph" %}
                <a href="{{ item.paper.file.url }}" download class="btn btn-soft border bg-white font-light border-gray-200 btn-sm dark:bg-gray-800 dark:border-gray-800 dark:text-gray-300">
                  Download PDF
                </a>
              {% endif %}
                <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" target="_blank" class="btn btn-soft btn-sm font-light border bg-red-600 text-white  border-gray-200 bg-white dark:bg-red-950/50 dark:border-red-800">
                  PDF 
                </a>
            {% endif %}
          
          {% if item.paper.merged_html %}
            <a href="{{ item.paper.merged_html.url }}" target="_blank" class="btn btn-soft btn-sm font-light border border-gray-200 bg-blue-600 text-white dark:bg-blue-950/50 dark:border-blue-800">HTML</a>
          {% endif %}
          {% if user.is_authenticated %}
          <div id="save-btn-{{ item.paper.id }}">
            {% include 'partials/save_button_list.html' with paper=item.paper is_saved=item.paper.is_saved %}
          </div>
          {% else %}
          <div class="text-center">
            <a href="{% url 'account_login' %}?next={% url 'paper_detail' item.paper.pk %}" class="text-sm text-subtle hover:underline">
          
            </a>
          </div>
          {% endif %}
        </div>
  {% endif %}
    </div>
  {% empty %}
    <div class="text-center text-gray-500 mt-12">No results found.</div>
  {% endfor %}

  <!-- Pagination Controls -->
<div class="mt-8 flex justify-center">
  <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
    {% if page_obj.has_previous %}
      <a hx-get="{% url 'paper_list_partial' %}"
         hx-target="#paper-list-container"
         hx-select="#paper-list-container"
         hx-push-url="true"
         hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
         hx-vals='{"page": {{ page_obj.previous_page_number }}, "view_mode": "{{ view_mode }}"}'
         class="px-3 py-2 border border-gray-300 bg-white text-gray-800 rounded-l-md hover:bg-gray-50 cursor-pointer dark:bg-gray-800 dark:border-gray-800 dark:text-gray-300 dark:hover:bg-gray-800">
        Previous
      </a>
    {% else %}
      <span class="px-3 py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded-l-md cursor-not-allowed dark:bg-gray-800 dark:border-gray-800">Previous</span>
    {% endif %}

    <span class="px-4 py-2 border-t border-b border-gray-300 bg-white text-gray-800 dark:bg-gray-800 dark:border-gray-800 dark:text-gray-300">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
      <a hx-get="{% url 'paper_list_partial' %}"
         hx-target="#paper-list-container"
         hx-select="#paper-list-container"
         hx-push-url="true"
         hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
         hx-vals='{"page": {{ page_obj.next_page_number }}, "view_mode": "{{ view_mode }}"}'
         class="px-3 py-2 border border-gray-300 bg-white text-gray-800 rounded-r-md hover:bg-gray-50 cursor-pointer dark:bg-gray-800 dark:border-gray-800 dark:text-gray-300 dark:hover:bg-gray-800">
        Next
      </a>
    {% else %}
      <span class="px-3 py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded-r-md cursor-not-allowed dark:bg-gray-800 dark:border-gray-800">Next</span>
    {% endif %}
  </nav>
</div>
</div>

<!-- Tags Section (separate, loaded independently) -->
<div id="tags" class="flex flex-wrap gap-3">
  {% for tag, count in tag_counts.items %}
    {% cycle 'blue' 'purple' 'green' 'yellow' 'orange' 'red' 'cyan' as color silent %}
    <a href="#"
       hx-get="{% url 'paper_list_partial' %}"
       hx-target="#paper-list-container"
       hx-select="#paper-list-container"
       hx-include="#filters"
       hx-vals='{"tag": ["{{ tag }}"]}'>
      <span class="flex items-center gap-2 rounded-full font-semibold border border-transparent px-4 py-2 transition duration-200
                   {% if count > 6 %}text-xl px-5 py-2{% elif count > 3 %}text-base px-4 py-1.5{% else %}text-sm px-3 py-1{% endif %}
                   {% if color == 'blue' %}bg-blue-100 text-blue-800  hover:bg-blue-200 dark:bg-blue-950 dark:text-blue-300{% endif %}
                   {% if color == 'purple' %}bg-purple-100 text-purple-800  hover:bg-purple-200 dark:bg-purple-950 dark:text-purple-300{% endif %}
                   {% if color == 'green' %}bg-green-100 text-green-800  hover:bg-green-200 dark:bg-green-950 dark:text-green-300{% endif %}
                   {% if color == 'yellow' %}bg-yellow-100 text-yellow-800  hover:bg-yellow-200 dark:bg-yellow-950 dark:text-yellow-300{% endif %}
                   {% if color == 'orange' %}bg-orange-100 text-orange-800  hover:bg-orange-200 dark:bg-orange-950 dark:text-orange-300{% endif %}
                   {% if color == 'red' %}bg-red-100 text-red-800  hover:bg-red-200 dark:bg-red-950 dark:text-red-300{% endif %}
                   {% if color == 'cyan' %}bg-cyan-100 text-cyan-800  hover:bg-cyan-200 dark:bg-cyan-950 dark:text-cyan-300{% endif %}">
        {{ tag }}
        <span class="opacity-70 text-xs font-bold">({{ count }})</span>
      </span>
    </a>
  {% empty %}
    <div class="flex flex-col items-center justify-center py-8">
      <svg class="w-10 h-10 text-blue-100 mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>
        <path d="M8 12h8M12 8v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span class="text-gray-600 text-sm font-semibold">No tags found</span>
      <span class="text-gray-300 text-xs">Tags will appear here when available.</span>
    </div>
  {% endfor %}
</div>
