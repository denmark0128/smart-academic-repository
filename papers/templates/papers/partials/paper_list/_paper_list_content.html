{% load static %}
<!-- OOB swap for Active Filters -->
<div id="active-filters" hx-swap-oob="true">
  {% include "papers/partials/paper_list/_active_filters.html" %}
</div>

{% if query %}
  <h2 class="text-lg font-semibold mb-4">
    {{ page_obj.paginator.count }} result{{ page_obj.paginator.count|pluralize }} for "<span class="text-black">{{ query }}</span>"
  </h2>
{% endif %}

<!-- Search Results -->
{% if view_mode == 'compact' %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% for item in page_obj %}
      <div class="border rounded-xl bg-white p-4 border-gray-200 hover:shadow transition flex flex-col h-full">
        {% if item.paper %}
          <a href="{% url 'paper_detail' item.paper.pk %}" class="font-semibold text-base text-black hover:underline mb-1">{{ item.paper.title }}</a>
        {% else %}
          <span class="text-base text-gray-400 font-semibold">[Paper not found]</span>
        {% endif %}
        <div class="text-xs text-gray-700 mb-1">
          {% if item.paper and item.paper.authors %}
            {{ item.paper.authors|join:', ' }}
          {% endif %}
        </div>
        <div class="text-xs text-gray-500 mb-1">
          {% if item.paper %}{{ item.paper.college }}{% endif %} {% if item.paper %}{{ item.paper.program }}{% endif %} {% if item.paper %}- {{ item.paper.year }}{% endif %}
        </div>
        <div class="text-xs text-gray-600 mb-1">
          {% if item.snippet %}{{ item.snippet|truncatechars_html:100|safe }}{% endif %}
        </div>
        <div class="flex flex-wrap gap-1 mb-2">
          {% if item.tags %}
            {% for tag in item.tags %}
              <span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full text-xs">{{ tag }}</span>
            {% endfor %}
          {% endif %}
        </div>
        <div class="mt-auto flex gap-2">
          {% if item.paper %}
            <a href="{{ item.paper.file.url }}" download class="btn btn-xs btn-outline text-red-600">PDF</a>
            <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" target="_blank" class="btn btn-xs btn-outline">View</a>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <div class="col-span-2 text-center text-gray-500 py-8">No results found.</div>
    {% endfor %}
  </div>
{% else %}
  {% for item in page_obj %}
    <div class="mb-8 border rounded-2xl bg-white p-6 border-gray-200 pb-12 hover:shadow-lg transition">
      <!-- Title -->
      {% if item.paper %}
        <a href="{% url 'paper_detail' item.paper.pk %}" class="text-xl text-black font-semibold hover:underline">
          {{ item.paper.title }}
        </a>
      {% else %}
        <span class="text-xl text-gray-400 font-semibold">[Paper not found]</span>
      {% endif %}

      <!-- Author -->
      {% with paper=item.paper %}
        {% if paper.authors %}
          <div>
            {% for author in paper.authors %}
              <span class="p-1 bg-grey-300 text-gray-700 text-sm">{{ author }}</span>{% if not forloop.last %} {% endif %}
            {% endfor %}
            - 
            <span class="ml-2 uppercase text-sm text-gray-600">
              {{ paper.college }} {{ paper.program }}
            </span>
            - <span class="text-grey-500">{{ paper.year }}</span>
          </div>
        {% endif %}
      {% endwith %}
        
      <!-- Snippet -->
      <div x-data="{ expanded: false }" x-cloak class="mt-2 text-gray-600 text-sm leading-relaxed">
        {% if item.snippet|length > 180 %}
          <!-- Collapsed view -->
          <span x-show="!expanded">
            {{ item.snippet|truncatechars_html:180|safe }} 
            <button @click="expanded = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
          </span>

          <!-- Expanded view -->
          <span x-show="expanded">
            {{ item.snippet|safe }} 
            <button @click="expanded = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
          </span>
        {% else %}
          {{ item.snippet|safe }} 
        {% endif %}
      </div>

      {% if item.paper and item.paper.abstract %}
        <div x-data="{ expandedAbs: false }" x-cloak class="mt-2 text-gray-700 text-xs leading-relaxed">
          <span class="font-semibold text-gray-500">Abstract:</span>
          {% if item.paper.abstract|length > 400 %}
            <span x-show="!expandedAbs">
              {{ item.paper.abstract|truncatechars_html:400|safe }}
              <button @click="expandedAbs = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
            </span>
            <span x-show="expandedAbs">
              {{ item.paper.abstract|safe }}
              <button @click="expandedAbs = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
            </span>
          {% else %}
            {{ item.paper.abstract|safe }}
          {% endif %}
        </div>
      {% endif %}

      {% if item.paper.summary %}
        <div x-data="{ open: false }" x-cloak class="mt-2">
          <button
            @click="open = !open"
            class="text-yellow-800 font-semibold hover:underline focus:outline-none"
          >
            <span x-text="open ? 'Hide Summary' : 'Show Summary'"></span>
          </button>

          <div
            x-show="open"
            x-transition
            class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded text-gray-800"
          >
            <span class="font-semibold text-yellow-800">Summary:</span>
            <span>{{ item.paper.summary }}</span>
          </div>
        </div>
      {% endif %}

      <!-- Tags (Alpine mapping) -->
      {% if item.tags %}
        <div x-data="{
            // mapping of topic -> {bg, text}
            topics: {
              'computer science': {bg: 'bg-blue-100', text: 'text-blue-800', title: 'Computer Science'},
              'computer': {bg: 'bg-blue-100', text: 'text-blue-800', title: 'Computer Science'},
              'cs': {bg: 'bg-blue-100', text: 'text-blue-800', title: 'Computer Science'},
              'machine learning': {bg: 'bg-green-100', text: 'text-green-800', title: 'Machine Learning'},
              'ml': {bg: 'bg-green-100', text: 'text-green-800', title: 'Machine Learning'},
              'deep learning': {bg: 'bg-green-100', text: 'text-green-800', title: 'Machine Learning'},
              'neural': {bg: 'bg-green-100', text: 'text-green-800', title: 'Machine Learning'},
              'data science': {bg: 'bg-teal-100', text: 'text-teal-800', title: 'Data Science'},
              'data': {bg: 'bg-teal-100', text: 'text-teal-800', title: 'Data Science'},
              'mathematics': {bg: 'bg-purple-100', text: 'text-purple-800', title: 'Mathematics'},
              'math': {bg: 'bg-purple-100', text: 'text-purple-800', title: 'Mathematics'},
              'statistics': {bg: 'bg-purple-100', text: 'text-purple-800', title: 'Mathematics'},
              'biology': {bg: 'bg-emerald-100', text: 'text-emerald-800', title: 'Biology'},
              'bio': {bg: 'bg-emerald-100', text: 'text-emerald-800', title: 'Biology'},
              'medicine': {bg: 'bg-red-100', text: 'text-red-800', title: 'Medicine'},
              'medical': {bg: 'bg-red-100', text: 'text-red-800', title: 'Medicine'},
              'physics': {bg: 'bg-slate-100', text: 'text-slate-900', title: 'Physics'}
            },
            // helper to find topic by substring matching
            findTopic(tag){
              const t = tag.toLowerCase();
              for(const k in this.topics){
                if(t.includes(k)) return this.topics[k];
              }
              return null;
            }
          }" class="mt-3 flex flex-wrap gap-2 text-xs">
          {% for tag in item.tags %}
            <a href="#" 
               hx-get="{% url 'paper_list' %}"
               hx-target="#papers-content"
               hx-push-url="true"
               hx-include="[name='college'],[name='program'],[name='year']"
               hx-vals='{"tag": "{{ tag }}"}'>
              <span x-text="'{{ tag }}'"
                    x-bind:class="(findTopic('{{ tag }}') ? (findTopic('{{ tag }}').bg + ' ' + findTopic('{{ tag }}').text) : 'bg-gray-200 text-gray-700') + ' font-semibold px-2 py-1 rounded-full hover:opacity-90'"
                    x-bind:title="(findTopic('{{ tag }}') ? findTopic('{{ tag }}').title : 'Other')">
                {{ tag }}
              </span>
            </a>
          {% endfor %}
        </div>
      {% endif %}
      <!-- Actions -->
  {% if item.paper %}
    <div class="mt-4 flex items-center gap-2">
      <a href="{{ item.paper.file.url }}" download class="btn btn-xs btn-outline text-red-600">
        Download PDF
      </a>
      <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" 
         target="_blank" class="btn btn-xs btn-outline">
        View in PDF Viewer
      </a>
      <div id="save-btn-{{ item.paper.id }}">
        {% include 'partials/_save_button_list.html' with paper=item.paper is_saved=is_saved %}
      </div>
      </div>
  {% endif %}
    </div>
  {% empty %}
    <div class="text-center text-gray-500 mt-12">No results found.</div>
  {% endfor %}
{% endif %}



<!-- Pagination Controls -->
<div class="mt-8 flex justify-center">
  <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
    {% if page_obj.has_previous %}
      <a hx-get="{% url 'paper_list' %}"
         hx-target="#papers-content"
         hx-push-url="true"
         hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
         hx-vals='{"page": "{{ page_obj.previous_page_number }}"}' 
         class="px-3 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 rounded-l-md">Previous</a>
    {% else %}
      <span class="px-3 py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded-l-md cursor-not-allowed">Previous</span>
    {% endif %}

    <span class="px-4 py-2 border-t border-b border-gray-300 bg-white text-gray-700">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
      <a hx-get="{% url 'paper_list' %}"
         hx-target="#papers-content"
         hx-push-url="true"
         hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
         hx-vals='{"page": "{{ page_obj.next_page_number }}"}'
         class="px-3 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 rounded-r-md">Next</a>
    {% else %}
      <span class="px-3 py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded-r-md cursor-not-allowed">Next</span>
    {% endif %}
  </nav>
</div>