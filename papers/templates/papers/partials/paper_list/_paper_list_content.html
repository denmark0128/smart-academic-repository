<!-- OOB swap for Active Filters -->
<div id="active-filters" hx-swap-oob="true">
  {% include "papers/partials/paper_list/_active_filters.html" %}
</div>

{% if query %}
  <h2 class="text-lg font-semibold mb-4">
    {{ page_obj.paginator.count }} result{{ page_obj.paginator.count|pluralize }} for "<span class="text-black">{{ query }}</span>"
  </h2>
{% endif %}

<!-- Search Results -->
{% for item in page_obj %}
  <div class="mb-8 border-b border-gray-200 pb-4">
    <!-- Title -->
    {% if item.paper %}
      <a href="{% url 'paper_detail' item.paper.pk %}" class="text-xl text-blue-800 font-semibold hover:underline">
        {{ item.paper.title }}
      </a>
    {% else %}
      <span class="text-xl text-gray-400 font-semibold">[Paper not found]</span>
    {% endif %}

    <!-- Author -->
    {% with paper=item.paper %}
      {% if paper.authors %}
        <div>
          {% for author in paper.authors %}
            <span class="p-1 bg-grey-300 text-green-900">{{ author }}</span>{% if not forloop.last %} {% endif %}
          {% endfor %}
          - 
          <span class="ml-2 uppercase text-sm text-gray-600">
            {{ paper.college }} {{ paper.program }}
          </span>
          - <span class="text-grey-500">{{ paper.year }}</span>
        </div>
      {% endif %}
    {% endwith %}
      
    <!-- Snippet -->
    <div x-data="{ expanded: false }" class="mt-2 text-gray-600 text-sm leading-relaxed">
      {% if item.snippet|length > 180 %}
        <!-- Collapsed view -->
        <span x-show="!expanded">
          {{ item.snippet|truncatechars_html:180|safe }} 
          <button @click="expanded = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
        </span>

        <!-- Expanded view -->
        <span x-show="expanded">
          {{ item.snippet|safe }} 
          <button @click="expanded = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
        </span>
      {% else %}
        {{ item.snippet|safe }} 
      {% endif %}
    </div>

    {% if item.paper.summary %}
      <div x-data="{ open: false }" class="mt-2">
        <button
          @click="open = !open"
          class="text-yellow-800 font-semibold hover:underline focus:outline-none"
        >
          <span x-text="open ? 'Hide Summary' : 'Show Summary'"></span>
        </button>

        <div
          x-show="open"
          x-transition
          class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded text-gray-800"
        >
          <span class="font-semibold text-yellow-800">Summary:</span>
          <span>{{ item.paper.summary }}</span>
        </div>
      </div>
    {% endif %}

    <!-- Tags -->
    {% if item.tags %}
      <div class="mt-3 flex flex-wrap gap-2 text-xs">
        {% for tag in item.tags %}
          <a href="#" 
             hx-get="{% url 'paper_list' %}"
             hx-target="#papers-content"
             hx-push-url="true"
             hx-include="[name='college'],[name='program'],[name='year']"
             hx-vals='{"tag": "{{ tag }}"}'>
            <span class="inline-block bg-gray-200 text-gray-700 font-semibold px-2 py-1 rounded-full hover:bg-gray-300">
              {{ tag }}
            </span>
          </a>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% empty %}
  <div class="text-center text-gray-500 mt-12">No results found.</div>
{% endfor %}

<!-- Pagination Controls -->
<div class="mt-8 flex justify-center">
  <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
    {% if page_obj.has_previous %}
      <a hx-get="{% url 'paper_list' %}"
         hx-target="#papers-content"
         hx-push-url="true"
         hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
         hx-vals='{"page": "{{ page_obj.previous_page_number }}"}' 
         class="px-3 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 rounded-l-md">Previous</a>
    {% else %}
      <span class="px-3 py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded-l-md cursor-not-allowed">Previous</span>
    {% endif %}

    <span class="px-4 py-2 border-t border-b border-gray-300 bg-white text-gray-700">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
      <a hx-get="{% url 'paper_list' %}"
         hx-target="#papers-content"
         hx-push-url="true"
         hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
         hx-vals='{"page": "{{ page_obj.next_page_number }}"}'
         class="px-3 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 rounded-r-md">Next</a>
    {% else %}
      <span class="px-3 py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded-r-md cursor-not-allowed">Next</span>
    {% endif %}
  </nav>
</div>