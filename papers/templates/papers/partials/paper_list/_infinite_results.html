{% load static %}

<!-- This template is used ONLY for infinite scroll appends -->
<!-- Wrapper that HTMX will use to replace the trigger -->
<div id="page-{{ page_obj.number }}-content">
  <!-- Compact View Items -->
  <div x-show="view === 'compact'" class="contents">
    {% for item in page_obj %}
      <div class="border rounded-lg bg-white p-4 border-gray-200 hover:shadow transition flex flex-col h-full dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-300
      {% if item.paper.college == 'ccs' %}border-l-4 border-l-slate-800 dark:border-l-gray-400{% elif item.paper.college == 'cba' %}border-l-4  border-l-yellow-400{% endif %}">
        
        {% if item.paper %}
          <a href="{% url 'paper_detail' item.paper.pk %}" class="font-semibold text-base text-gray-900 tracking-tight hover:underline mb-1 dark:text-zinc-300">{{ item.paper.title }}</a>
          {% if item.score and item.score != '-' %}
            <div class="text-xs text-gray-500 mb-1 dark:text-zinc-400">
              Similarity: {{ item.score }}
            </div>
          {% endif %}
        {% else %}
          <span class="text-base text-gray-400 font-semibold dark:text-zinc-300">[Paper not found]</span>
        {% endif %}

        <div class="text-xs text-gray-700 mb-1 dark:text-zinc-300">
          {% if item.paper and item.paper.authors %}
            {{ item.paper.authors|join:', ' }}
          {% endif %}
        </div>

        <div class="text-xs text-gray-500 mb-1 dark:text-zinc-300">
          {% if item.paper %}{{ item.paper.college }}{% endif %} {% if item.paper %}{{ item.paper.program }}{% endif %} {% if item.paper %}- {{ item.paper.year }}{% endif %}
        </div>
        <div class="text-xs mb-1 ">
          {% if item.snippet %}{{ item.snippet|truncatechars_html:100|safe }}{% endif %}
        </div>
        <div class="flex flex-wrap gap-1 mb-2">
          {% if item.tags %}
            {% for tag in item.tags %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
            {{ tag }}
          </span>
            {% endfor %}
          {% endif %}
        </div>
        <div class="mt-auto flex gap-2">
          {% if item.paper %}
            <a href="{{ item.paper.file.url }}" download class="btn btn-xs btn-outline text-red-600">PDF</a>
            <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" target="_blank" class="btn btn-xs btn-outline dark:text-zinc-300 dark:hover:zinc-200">View</a>
            {% if item.paper.merged_html %}
              <a href="{{ item.paper.merged_html.url }}" target="_blank" class="btn btn-xs btn-outline dark:text-zinc-300 dark:hover:zinc-200">HTML</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Card View Items -->
  <div x-show="view === 'card'" class="contents">
    {% for item in page_obj %}
      <div class="mb-8 border rounded-lg bg-white p-6 border-gray-200 border-l-4 shadow-sm pb-12 hover:shadow-lg transition dark:bg-zinc-900 dark:border-zinc-700
      {% if item.paper.college == 'ccs' %}border-l-slate-800 dark:border-l-gray-400{% elif item.paper.college == 'cba' %}border-l-yellow-400{% endif %}">

        <!-- Title -->
        {% if item.paper %}
          <a href="{% url 'paper_detail' item.paper.pk %}" class="text-xl mb-2 text-black font-semibold hover:underline dark:text-zinc-300">
            {{ item.paper.title }}
          </a>
        {% else %}
          <span class="text-xl text-gray-400 font-semibold">[Paper not found]</span>
        {% endif %}

        {% if item.score and item.score != '-' %}
          <div class="text-xs text-gray-500 mb-1 dark:text-zinc-400">
            Similarity: {{ item.score }}
          </div>
        {% endif %}

        <!-- Author -->
        {% with paper=item.paper %}
          {% if paper.authors %}
            <div class="mt-3">
              {% for author in paper.authors %}
                <span class="p-1 bg-grey-300 text-gray-700 text-sm dark:bg-zinc-800 dark:text-zinc-300">{{ author }}</span>{% if not forloop.last %} {% endif %}
              {% endfor %}
              - 
              <span class="ml-2 uppercase text-sm text-gray-600 dark:text-zinc-300">
                {{ paper.college }} {{ paper.program }}
              </span>
              - <span class="text-grey-500 dark:text-zinc-300">{{ paper.year }}</span>
            </div>
          {% endif %}
        {% endwith %}
          
        <!-- Snippet -->
        <div x-data="{ expanded: false }" x-cloak class="mt-2 text-gray-600  text-sm leading-relaxed dark:text-zinc-300 ">
          {% if item.snippet|length > 180 %}
            <span x-show="!expanded">
              {{ item.snippet|truncatechars_html:180|safe }} 
              <button @click="expanded = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
            </span>
            <span x-show="expanded" class="dark:text-zinc-300">
              {{ item.snippet|safe }} 
              <button @click="expanded = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
            </span>
          {% else %}
            {{ item.snippet|safe }} 
          {% endif %}
        </div>

        {% if item.paper and item.paper.abstract %}
          <div x-data="{ expandedAbs: false }" x-cloak class="mt-4 text-gray-700 text-xs leading-relaxed">
            <span class="font-semibold text-gray-500">Abstract:</span>
            {% if item.paper.abstract|length > 400 %}
              <span x-show="!expandedAbs" class="dark:text-zinc-300">
                {{ item.paper.abstract|truncatechars_html:400|safe }}
                <button @click="expandedAbs = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
              </span>
              <span x-show="expandedAbs " class="dark:text-zinc-300">
                {{ item.paper.abstract|safe }}
                <button @click="expandedAbs = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
              </span>
            {% else %}
              {{ item.paper.abstract|safe }}
            {% endif %}
          </div>
        {% endif %}

        {% if item.paper.summary %}
          <div x-data="{ open: false }" x-cloak class="mt-2">
            <button
              @click="open = !open"
              class="text-yellow-800 font-semibold hover:underline focus:outline-none"
            >
              <span x-text="open ? 'Hide Summary' : 'Show Summary'"></span>
            </button>

            <div
              x-show="open"
              x-transition
              class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded text-gray-800 dark:bg-yellow-900 dark:border-yellow-600 dark:text-yellow-200"
            >
              <span class="font-semibold text-yellow-800 dark:text-yellow-600">Summary:</span>
              <span>{{ item.paper.summary }}</span>
            </div>
          </div>
        {% endif %}

        <!-- Tags -->
        {% if item.tags %}
          <div 
            x-data="{
              dark: window.matchMedia('(prefers-color-scheme: dark)').matches,
              topics: {},
              findTopic(tag){
                const t = tag.toLowerCase();
                for(const k in this.topics){
                  if(t.includes(k)) return this.topics[k];
                }
                return null;
              }
            }"
            x-init="window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => dark = e.matches)"
            class="mt-3 flex flex-wrap gap-2 text-xs mt-6"
          > 
            {% for tag in item.tags %}
              <a href="#"
                hx-get="{% url 'paper_list_partial' %}"
                hx-target="#paper-list-container"
                hx-select="#paper-list-container"
                hx-push-url="true"
                hx-include="[name='college'],[name='program'],[name='year']"
                hx-vals='{"tag": "{{ tag }}"}'>
                <span
                  x-text="'{{ tag }}'"
                  x-bind:class="(() => {
                    const t = findTopic('{{ tag }}');
                    if (!t) return ' items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors';
                    return (dark ? t.dark.bg + ' ' + t.dark.text : t.bg + ' ' + t.text) + ' font-semibold px-2 py-1 rounded-full hover:opacity-90';
                  })()"
                  x-bind:title="findTopic('{{ tag }}')?.title || 'Other'"
                ></span>
              </a>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Actions -->
        {% if item.paper %}
          <div class="flex flex-row justify-end gap-2 w-full items-center mt-6">
            {% if ".pdf" in item.paper.file.name %}
              <a href="{{ item.paper.file.url }}" download class="btn btn-soft border bg-white font-light border-gray-200 btn-sm dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300">
                Download PDF
              </a>
              <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" target="_blank" class="btn btn-soft btn-sm font-light border bg-red-600 text-white  border-gray-200 bg-white dark:bg-red-900/50 dark:border-red-800">
                PDF 
              </a>
            {% endif %}
            {% if item.paper.merged_html %}
              <a href="{{ item.paper.merged_html.url }}" target="_blank" class="btn btn-soft btn-sm font-light border border-gray-200 bg-blue-600 text-white dark:bg-blue-900/50 dark:border-blue-800">HTML</a>
            {% endif %}
            {% if user.is_authenticated %}
              <div id="save-btn-{{ item.paper.id }}">
                {% include 'partials/save_button_list.html' with paper=item.paper is_saved=item.paper.is_saved %}
              </div>
            {% else %}
              <div class="text-center">
                <a href="{% url 'account_login' %}?next={% url 'paper_detail' item.paper.pk %}" class="text-sm text-subtle hover:underline"></a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<!-- Next page trigger (replaces itself with new content + trigger) -->
{% if page_obj.has_next %}
  <div id="load-more-trigger"
       hx-get="{% url 'paper_list_partial' %}"
       hx-trigger="intersect once"
       hx-target="this"
       hx-swap="beforebegin"
       hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
       hx-vals='{"page": {{ page_obj.next_page_number }}, "view_mode": "{{ view_mode }}", "infinite": "true"}'
       class="flex justify-center py-8 col-span-full w-full">
    <div class="flex items-center gap-2 text-gray-500">
      <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Loading more...</span>
    </div>
  </div>
{% else %}
  <div class="flex justify-center py-8 text-gray-500 text-sm col-span-full w-full">
    <span>No more results</span>
  </div>
{% endif %}
<div x-show="view === 'compact'" class="contents">
  {% for item in page_obj %}
    <div class="border rounded-lg bg-white p-4 border-gray-200 hover:shadow transition flex flex-col h-full dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-300
    {% if item.paper.college == 'ccs' %}border-l-4 border-l-slate-800 dark:border-l-gray-400{% elif item.paper.college == 'cba' %}border-l-4  border-l-yellow-400{% endif %}">
      
      {% if item.paper %}
        <a href="{% url 'paper_detail' item.paper.pk %}" class="font-semibold text-base text-gray-900 tracking-tight hover:underline mb-1 dark:text-zinc-300">{{ item.paper.title }}</a>
        {% if item.score and item.score != '-' %}
          <div class="text-xs text-gray-500 mb-1 dark:text-zinc-400">
            Similarity: {{ item.score }}
          </div>
        {% endif %}
      {% else %}
        <span class="text-base text-gray-400 font-semibold dark:text-zinc-300">[Paper not found]</span>
      {% endif %}

      <div class="text-xs text-gray-700 mb-1 dark:text-zinc-300">
        {% if item.paper and item.paper.authors %}
          {{ item.paper.authors|join:', ' }}
        {% endif %}
      </div>

      <div class="text-xs text-gray-500 mb-1 dark:text-zinc-300">
        {% if item.paper %}{{ item.paper.college }}{% endif %} {% if item.paper %}{{ item.paper.program }}{% endif %} {% if item.paper %}- {{ item.paper.year }}{% endif %}
      </div>
      <div class="text-xs mb-1 ">
        {% if item.snippet %}{{ item.snippet|truncatechars_html:100|safe }}{% endif %}
      </div>
      <div class="flex flex-wrap gap-1 mb-2">
        {% if item.tags %}
          {% for tag in item.tags %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
          {{ tag }}
        </span>
          {% endfor %}
        {% endif %}
      </div>
      <div class="mt-auto flex gap-2">
        {% if item.paper %}
          <a href="{{ item.paper.file.url }}" download class="btn btn-xs btn-outline text-red-600">PDF</a>
          <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" target="_blank" class="btn btn-xs btn-outline dark:text-zinc-300 dark:hover:zinc-200">View</a>
          {% if item.paper.merged_html %}
            <a href="{{ item.paper.merged_html.url }}" target="_blank" class="btn btn-xs btn-outline dark:text-zinc-300 dark:hover:zinc-200">HTML</a>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- Card View Items -->
<div x-show="view === 'card'" class="contents">
  {% for item in page_obj %}
    <div class="mb-8 border rounded-lg bg-white p-6 border-gray-200 border-l-4 shadow-sm pb-12 hover:shadow-lg transition dark:bg-zinc-900 dark:border-zinc-700
    {% if item.paper.college == 'ccs' %}border-l-slate-800 dark:border-l-gray-400{% elif item.paper.college == 'cba' %}border-l-yellow-400{% endif %}">

      <!-- Title -->
      {% if item.paper %}
        <a href="{% url 'paper_detail' item.paper.pk %}" class="text-xl mb-2 text-black font-semibold hover:underline dark:text-zinc-300">
          {{ item.paper.title }}
        </a>
      {% else %}
        <span class="text-xl text-gray-400 font-semibold">[Paper not found]</span>
      {% endif %}

      {% if item.score and item.score != '-' %}
        <div class="text-xs text-gray-500 mb-1 dark:text-zinc-400">
          Similarity: {{ item.score }}
        </div>
      {% endif %}

      <!-- Author -->
      {% with paper=item.paper %}
        {% if paper.authors %}
          <div class="mt-3">
            {% for author in paper.authors %}
              <span class="p-1 bg-grey-300 text-gray-700 text-sm dark:bg-zinc-800 dark:text-zinc-300">{{ author }}</span>{% if not forloop.last %} {% endif %}
            {% endfor %}
            - 
            <span class="ml-2 uppercase text-sm text-gray-600 dark:text-zinc-300">
              {{ paper.college }} {{ paper.program }}
            </span>
            - <span class="text-grey-500 dark:text-zinc-300">{{ paper.year }}</span>
          </div>
        {% endif %}
      {% endwith %}
        
      <!-- Snippet -->
      <div x-data="{ expanded: false }" x-cloak class="mt-2 text-gray-600  text-sm leading-relaxed dark:text-zinc-300 ">
        {% if item.snippet|length > 180 %}
          <span x-show="!expanded">
            {{ item.snippet|truncatechars_html:180|safe }} 
            <button @click="expanded = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
          </span>
          <span x-show="expanded" class="dark:text-zinc-300">
            {{ item.snippet|safe }} 
            <button @click="expanded = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
          </span>
        {% else %}
          {{ item.snippet|safe }} 
        {% endif %}
      </div>

      {% if item.paper and item.paper.abstract %}
        <div x-data="{ expandedAbs: false }" x-cloak class="mt-4 text-gray-700 text-xs leading-relaxed">
          <span class="font-semibold text-gray-500">Abstract:</span>
          {% if item.paper.abstract|length > 400 %}
            <span x-show="!expandedAbs" class="dark:text-zinc-300">
              {{ item.paper.abstract|truncatechars_html:400|safe }}
              <button @click="expandedAbs = true" class="text-blue-600 hover:underline text-xs ml-1">Read more</button>
            </span>
            <span x-show="expandedAbs " class="dark:text-zinc-300">
              {{ item.paper.abstract|safe }}
              <button @click="expandedAbs = false" class="text-blue-600 hover:underline text-xs ml-1">See less</button>
            </span>
          {% else %}
            {{ item.paper.abstract|safe }}
          {% endif %}
        </div>
      {% endif %}

      {% if item.paper.summary %}
        <div x-data="{ open: false }" x-cloak class="mt-2">
          <button
            @click="open = !open"
            class="text-yellow-800 font-semibold hover:underline focus:outline-none"
          >
            <span x-text="open ? 'Hide Summary' : 'Show Summary'"></span>
          </button>

          <div
            x-show="open"
            x-transition
            class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded text-gray-800 dark:bg-yellow-900 dark:border-yellow-600 dark:text-yellow-200"
          >
            <span class="font-semibold text-yellow-800 dark:text-yellow-600">Summary:</span>
            <span>{{ item.paper.summary }}</span>
          </div>
        </div>
      {% endif %}

      <!-- Tags -->
      {% if item.tags %}
        <div 
          x-data="{
            dark: window.matchMedia('(prefers-color-scheme: dark)').matches,
            topics: {},
            findTopic(tag){
              const t = tag.toLowerCase();
              for(const k in this.topics){
                if(t.includes(k)) return this.topics[k];
              }
              return null;
            }
          }"
          x-init="window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => dark = e.matches)"
          class="mt-3 flex flex-wrap gap-2 text-xs mt-6"
        > 
          {% for tag in item.tags %}
            <a href="#"
              hx-get="{% url 'paper_list_partial' %}"
              hx-target="#paper-list-container"
              hx-select="#paper-list-container"
              hx-push-url="true"
              hx-include="[name='college'],[name='program'],[name='year']"
              hx-vals='{"tag": "{{ tag }}"}'>
              <span
                x-text="'{{ tag }}'"
                x-bind:class="(() => {
                  const t = findTopic('{{ tag }}');
                  if (!t) return ' items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors';
                  return (dark ? t.dark.bg + ' ' + t.dark.text : t.bg + ' ' + t.text) + ' font-semibold px-2 py-1 rounded-full hover:opacity-90';
                })()"
                x-bind:title="findTopic('{{ tag }}')?.title || 'Other'"
              ></span>
            </a>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Actions -->
      {% if item.paper %}
        <div class="flex flex-row justify-end gap-2 w-full items-center mt-6">
          {% if ".pdf" in item.paper.file.name %}
            <a href="{{ item.paper.file.url }}" download class="btn btn-soft border bg-white font-light border-gray-200 btn-sm dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300">
              Download PDF
            </a>
            <a href="{% static 'pdfjs/web/viewer.html' %}?file={{ item.paper.file.url }}" target="_blank" class="btn btn-soft btn-sm font-light border bg-red-600 text-white  border-gray-200 bg-white dark:bg-red-900/50 dark:border-red-800">
              PDF 
            </a>
          {% endif %}
          {% if item.paper.merged_html %}
            <a href="{{ item.paper.merged_html.url }}" target="_blank" class="btn btn-soft btn-sm font-light border border-gray-200 bg-blue-600 text-white dark:bg-blue-900/50 dark:border-blue-800">HTML</a>
          {% endif %}
          {% if user.is_authenticated %}
            <div id="save-btn-{{ item.paper.id }}">
              {% include 'partials/save_button_list.html' with paper=item.paper is_saved=item.paper.is_saved %}
            </div>
          {% else %}
            <div class="text-center">
              <a href="{% url 'account_login' %}?next={% url 'paper_detail' item.paper.pk %}" class="text-sm text-subtle hover:underline"></a>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<!-- Next page trigger (replaces itself with new trigger) -->
{% if page_obj.has_next %}
  <div id="load-more-trigger"
       hx-get="{% url 'paper_list_partial' %}"
       hx-trigger="intersect once"
       hx-target="this"
       hx-swap="outerHTML"
       hx-include="[name='college'],[name='program'],[name='year'],[name='tag']"
       hx-vals='{"page": {{ page_obj.next_page_number }}, "view_mode": "{{ view_mode }}", "infinite": "true"}'
       class="flex justify-center py-8 col-span-full w-full">
    <div class="flex items-center gap-2 text-gray-500">
      <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Loading more...</span>
    </div>
  </div>
{% else %}
  <div class="flex justify-center py-8 text-gray-500 text-sm col-span-full w-full">
    <span>No more results</span>
  </div>
{% endif %}