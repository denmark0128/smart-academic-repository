<div x-data="{ searchQuery: '', filterStatus: '' }" class="space-y-4">

  <!-- Search + Filter -->
  <div class="flex flex-col md:flex-row gap-2 md:gap-4">
    <input 
      type="text" 
      placeholder="Search tag name..." 
      x-model="searchQuery"
      class="input input-bordered w-full border border-gray-300 rounded-lg shadow-sm md:w-1/2 dark:text-zinc-300 dark:bg-zinc-800 dark:border-zinc-700 p-2">

    <select x-model="filterStatus"
            class="select select-bordered w-full border border-gray-300 rounded-lg shadow-sm md:w-1/4 dark:text-zinc-300 dark:bg-zinc-800 dark:border-zinc-700 p-2">
      <option value="">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>

    <!-- Refresh Button (like in dashboard) -->
    <button 
      class="btn btn-outline btn-sm md:ml-auto"
      @click="htmx.trigger($refs.tagsTable, 'load')">
       Refresh
    </button>
  </div>

  <!-- Tags Table -->
  <div class="overflow-x-auto rounded-lg border border-gray-300 dark:bg-zinc-900 dark:border-zinc-700">
    <table class="table table-xs w-full rounded-lg table-zebra dark:[&>tbody>tr:nth-child(even)]:bg-zinc-800 dark:[&>tbody>tr:nth-child(odd)]:bg-zinc-900 " x-ref="tagsTable">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-200 dark:bg-zinc-900 dark:border-zinc-700">
          <th class="py-4 px-6 text-left text-sm font-semibold text-gray-700 dark:text-zinc-300">Tag Name</th>
          <th class="py-4 px-6 text-left text-sm font-semibold text-gray-700 dark:text-zinc-300">Embedding status</th>
          <th class="py-4 px-6 text-left text-sm font-semibold text-gray-700 dark:text-zinc-300">Status</th>
          <th class="py-4 px-6 text-left text-sm font-semibold text-gray-700 dark:text-zinc-300">Papers Count</th>
          <th class="py-4 px-6 text-left text-sm font-semibold text-gray-700 dark:text-zinc-300">Created</th>
          <th class="py-4 px-6 text-right text-sm font-semibold text-gray-700 dark:text-zinc-300">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for tag in tags %}
        <tr 
          x-show="(
            (!searchQuery || '{{ tag.name|escapejs }}'.toLowerCase().includes(searchQuery.toLowerCase())) &&
            (!filterStatus || 
              (filterStatus === 'active' && '{{ tag.is_active }}' === 'True') ||
              (filterStatus === 'inactive' && '{{ tag.is_active }}' === 'False')
            )
          )"
          class="border-b border-gray-100 hover:bg-gray-50 transition-colors dark:border-zinc-700"
        >
          <td class="py-2 px-3 text-sm font-medium text-gray-800 dark:text-zinc-300">
            {{ tag.name }}
          </td>
          <td class="py-4 px-6">
           {% if tag.embedding is not None %}
            <span class="px-2 py-1 text-xs font-medium text-blue-700 bg-blue-100 rounded dark:text-blue-300 dark:bg-blue-900">âœ“ Ready</span>
          {% else %}
            <span class="px-2 py-1 text-xs font-medium text-orange-700 bg-orange-100 rounded dark:text-orange-300 dark:bg-orange-900">Missing</span>
          {% endif %}
          <td class="py-4 px-6">
            {% if tag.is_active %}
              <span class="px-3 py-1 text-xs font-medium text-green-700 bg-green-100 rounded-full dark:text-green-300 dark:bg-green-900">Active</span>
            {% else %}
              <span class="px-3 py-1 text-xs font-medium text-gray-700 bg-gray-100 rounded-full dark:text-red-300 dark:bg-red-900">Inactive</span>
            {% endif %}
          </td>
          <td class="py-4 px-6 text-sm text-gray-600 dark:text-zinc-300">{{ tag.paper_count }} paper{{ tag.paper_count|pluralize }}</td>
          <td class="py-4 px-6 text-sm text-gray-500 dark:text-zinc-300">{{ tag.created_at|date:"M d, Y" }}</td>
          <td class="py-4 px-6 text-right">
            <div class="flex justify-end gap-2">
            {% if tag.embedding is None %}
            <button 
              hx-post="{% url 'staff_tags_generate_embedding' tag.id %}"
              hx-target="#tags-table-container"
              hx-swap="innerHTML"
              hx-indicator="this"
              class="btn btn-sm btn-outline btn-primary text-xs"
              title="Generate embedding">
              <span class="htmx-indicator loading loading-spinner loading-xs"></span>
              <span>Generate Embed</span>
            </button>
            {% endif %}
            <!-- Edit Button -->
            <button 
              onclick="document.getElementById('tag-name-{{ tag.id }}').classList.add('hidden'); document.getElementById('tag-edit-{{ tag.id }}').classList.remove('hidden')"
              class="text-xs px-3 py-1 rounded bg-blue-100 text-blue-800 hover:bg-blue-200 transition dark:text-blue-300 dark:bg-blue-900"
              title="Edit tag">
              Edit
            </button>

            <!-- Toggle Active/Inactive -->
            <button 
              hx-post="{% url 'staff_tags_toggle' tag.id %}"
              hx-target="#tags-table-container"
              hx-swap="innerHTML"
              hx-include="[name='q'],[name='status']"
              class="text-xs px-3 py-1 rounded {% if tag.is_active %}bg-yellow-100 text-yellow-800 hover:bg-yellow-200 dark:bg-yellow-900 dark:text-yellow-300{% else %}bg-green-100 text-green-800 hover:bg-green-200{% endif %} transition"
              title="{% if tag.is_active %}Deactivate{% else %}Activate{% endif %}">
              {% if tag.is_active %}Deactivate{% else %}Activate{% endif %}
            </button>

            <!-- Delete Button -->
            <button 
              hx-post="{% url 'staff_tags_delete' tag.id %}"
              hx-target="#tags-table-container"
              hx-swap="innerHTML"
              hx-include="[name='q'],[name='status']"
              hx-confirm="Are you sure you want to delete '{{ tag.name }}'? This cannot be undone."
              class="btn btn-active btn-error btn-sm text-xs"
              title="Generate embedding">
              <span class="htmx-indicator loading loading-spinner loading-xs"></span>
              <span>Delete</span>
            </button>
          </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="py-8 px-6 text-center text-gray-500 text-sm">
            No tags found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
